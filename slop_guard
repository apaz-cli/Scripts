#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="/tmp/slop-guard"
VENV_DIR="/tmp/slop-guard-venv"

# Clone or update repo
if [ ! -d "$REPO_DIR/.git" ]; then
    git clone --depth 1 https://github.com/eric-tramel/slop-guard "$REPO_DIR"
else
    git -C "$REPO_DIR" pull --ff-only --quiet
fi

# Create venv and install package (editable so git updates are reflected)
if [ ! -d "$VENV_DIR" ]; then
    python3 -m venv "$VENV_DIR"
    "$VENV_DIR/bin/pip" install --quiet -e "$REPO_DIR"
fi

# If run interactively, register if needed then launch Claude Code.
if [ -t 0 ]; then
    if claude mcp get slop-guard &>/dev/null; then
        exec claude "$@"
    else
        claude mcp add --scope project slop-guard -- "$SCRIPT_DIR/slop_guard"
        echo "Registered slop-guard MCP server."
        exec claude "$@"
    fi
fi

# Non-interactive: run as MCP server
exec "$VENV_DIR/bin/slop-guard"
