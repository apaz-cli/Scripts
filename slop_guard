#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="/tmp/slop_guard_venv"

if [ ! -d "$VENV_DIR" ]; then
    python3 -m venv "$VENV_DIR"
    "$VENV_DIR/bin/pip" install mcp --quiet
    curl -fsSL https://raw.githubusercontent.com/eric-tramel/slop-guard/refs/heads/main/slop_guard.py \
        -o "$VENV_DIR/slop_guard.py"
fi

# If run interactively, register if needed then launch Claude Code.
if [ -t 0 ]; then
    if claude mcp get slop-guard &>/dev/null; then
        exec claude "$@"
    else
        claude mcp add --scope project slop-guard -- "$SCRIPT_DIR/slop_guard"
        echo "Registered slop-guard MCP server."
        exec claude "$@"
    fi
fi

exec "$VENV_DIR/bin/python" "$VENV_DIR/slop_guard.py" "$@"
