#!/usr/bin/env python3

import os
import subprocess
import sys
import shutil

def run_cmd(cmd, check=True, shell=True):
    """Run a command and return the result"""
    print(f"Running: \033[35m{cmd}\033[0m")
    result = subprocess.run(cmd, shell=shell, capture_output=True, text=True)
    if check and result.returncode != 0:
        print(f"Command failed: {cmd}")
        print(f"stdout: {result.stdout}")
        print(f"stderr: {result.stderr}")
        sys.exit(1)
    return result

def print_status(msg):
    """Print status message in yellow"""
    print(f"\033[33m{msg}\033[0m")

def check_nvidia_smi():
    """Check if nvidia-smi is available"""
    try:
        result = subprocess.run(["nvidia-smi", "--query-gpu=compute_cap", "--format=csv"],
                              capture_output=True, text=True)
        return result.returncode == 0
    except FileNotFoundError:
        return False

def get_cuda_arch():
    """Get CUDA architecture from nvidia-smi"""
    result = run_cmd('nvidia-smi --query-gpu=compute_cap --format=csv | tac | head -n1 | cut -b 2 --complement')
    return result.stdout.strip()

def check_cmake():
    """Check if cmake is installed, install if needed"""
    try:
        subprocess.run(["cmake", "--version"], capture_output=True, check=True)
        print_status("cmake is already installed")
    except (FileNotFoundError, subprocess.CalledProcessError):
        print("cmake not found, attempting to install...")
        if shutil.which("apt"):
            run_cmd("sudo apt update && sudo apt install -y cmake")
        else:
            print("apt not found, please install cmake manually")
            sys.exit(1)

def get_cpu_count():
    """Get number of CPU cores"""
    result = run_cmd('cat /proc/cpuinfo | grep processor | wc -l')
    return result.stdout.strip()

def main():
    # Clone llama.cpp repo
    print_status("Cloning llama.cpp repository...")
    os.chdir("/tmp")
    if os.path.exists("llama.cpp"):
        shutil.rmtree("llama.cpp")
    run_cmd("git clone https://github.com/ggerganov/llama.cpp.git")
    os.chdir("llama.cpp")

    # Check required paths
    paths = ["build-xcframework.sh", "CMakeLists.txt", "ggml", "src/"]
    print_status("Checking required paths...")
    for path in paths:
        if not os.path.exists(path):
            print(f"Required path not found: {path}")
            sys.exit(1)
    print_status("All required paths found")

    # Check and install cmake
    check_cmake()

    # Get CPU count for parallel build
    cpu_count = get_cpu_count()
    print_status(f"Using {cpu_count} cores for build")

    # Check for NVIDIA GPU
    has_nvidia = check_nvidia_smi()

    if has_nvidia:
        print_status("NVIDIA GPU detected, building with CUDA support...")
        cuda_arch = get_cuda_arch()
        print_status(f"CUDA architecture: {cuda_arch}")

        # Build with CUDA
        run_cmd(f'cmake -B build -DCMAKE_CUDA_ARCHITECTURES="{cuda_arch}"')
        build_cmd = f'cmake --build build --config Release -j {cpu_count}'
        run_cmd(build_cmd)

        # Test GPU build
        os.chdir("build/bin")
        run_cmd("./llama-server --help")
        print_status("GPU build test successful")
        os.chdir("../..")

        # Build CPU version
        print_status("Building CPU version...")
        run_cmd("cmake -B cpubuild")
        run_cmd(f"cmake --build cpubuild --config Release -j {cpu_count}")

        # Test CPU build
        os.chdir("cpubuild/bin")
        run_cmd("./llama-server --help")
        print_status("CPU build test successful")
        os.chdir("../..")

    else:
        print_status("No NVIDIA GPU detected, building CPU-only version...")
        run_cmd("cmake -B build")
        run_cmd(f"cmake --build build --config Release -j {cpu_count}")

        # Test build
        os.chdir("build/bin")
        run_cmd("./llama-server --help")
        print_status("CPU build test successful")
        os.chdir("../..")

    print()
    print_status("Build completed successfully!")
    print(f"Binaries available in: \033[35m{os.getcwd()}/build/bin/\033[0m")
    if has_nvidia:
        print(f"CPU binaries available in: \033[35m{os.getcwd()}/cpubuild/bin/\033[0m")

if __name__ == "__main__":
    main()


