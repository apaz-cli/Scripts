#!/usr/bin/env python3

import argparse
import sys
import os
import subprocess
from pygments import highlight
from pygments.lexers import get_lexer_for_filename, guess_lexer, get_lexer_by_name
from pygments.formatters import TerminalFormatter, Terminal256Formatter
from pygments.styles import get_style_by_name
from pygments.style import Style
from pygments.styles.monokai import MonokaiStyle

class CustomStyle(Style):
    """
    Custom style based on Monokai.
    You can modify the attributes here to customize your style.
    """
    styles = dict(MonokaiStyle.styles)

    # Example of how to modify a style (uncomment and adjust as needed):
    # String.styles['String'] = '#ff5555'
from pygments.util import ClassNotFound


def choose_lexer(file_path, content):
    try:
        return get_lexer_for_filename(file_path)
    except ClassNotFound:
        pass

    # Check for shebangs
    lines = content.split("\n")
    if lines and lines[0].startswith("#!"):
        if "python" in lines[0]:
            return get_lexer_by_name("python")
        elif "bash" in lines[0] or "sh" in lines[0]:
            return get_lexer_by_name("bash")

    # Check for C "shebang"
    if len(lines) > 1 and lines[0].strip() == "#if 0":
        next_line = lines[1].strip()
        if all(component in next_line for component in ["mktemp -d", "cc", "-x c", '"$0"']):
            return get_lexer_by_name("c")

    # Fallback to guessing
    return guess_lexer(content)


def fallback_to_cat(file_path):
    try:
        subprocess.run(["cat", file_path], check=True)
    except subprocess.CalledProcessError:
        print(f"Error: Failed to cat file '{file_path}'.", file=sys.stderr)


def cat_highlighted(file_path):
    try:
        with open(file_path, "r") as file:
            content = file.read()

        lexer = choose_lexer(file_path, content)
        term = os.environ.get('TERM', '')
        style = CustomStyle
        formatter = Terminal256Formatter(style=style) if '256color' in term or term in ['xterm-kitty'] else TerminalFormatter(style=style)
        highlighted = highlight(content, lexer, formatter)
        print(highlighted)

    except BaseException:
        fallback_to_cat(file_path)


def main():
    parser = argparse.ArgumentParser(description="Cat files with syntax highlighting.")
    parser.add_argument("files", nargs="+", help="File(s) to display")
    args = parser.parse_args()

    for file_path in args.files:
        cat_highlighted(file_path)


if __name__ == "__main__":
    main()
