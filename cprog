#if 0

# Run as a bash script.

# Create a temp dir to compile into and run out of.
TMP="$(mktemp -d /tmp/cshebang.XXXXXXXXX)"

cc -o "$TMP/a.out" -x c "$0" -O3 -lpthread && "$TMP/a.out" $@;

RVAL=$?;
rm -rf "$TMP";
exit $RVAL

#endif


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <unistd.h>
#include <limits.h>

// Template C program
const char *template_code = "#include \"cinclude.h\"\n"
                            "\n"
                            "int main(int argc, char** argv) {\n"
                            "    printf(\"Hello, World!\\n\");\n"
                            "    return 0;\n"
                            "}\n";

// Content for cinclude.h
const char *cinclude_content = "#ifndef CINCLUDE_H\n"
                               "#define CINCLUDE_H\n"
                               "\n"
                               "#include <stdio.h>\n"
                               "#include <stdlib.h>\n"
                               "#include <string.h>\n"
                               "#include <math.h>\n"
                               "#include <ctype.h>\n"
                               "#include <time.h>\n"
                               "#include <limits.h>\n"
                               "#include <float.h>\n"
                               "#include <assert.h>\n"
                               "#include <errno.h>\n"
                               "#include <locale.h>\n"
                               "#include <setjmp.h>\n"
                               "#include <signal.h>\n"
                               "#include <stdarg.h>\n"
                               "#include <stddef.h>\n"
                               "\n"
                               "#endif // CINCLUDE_H\n";

int file_exists(const char *filename) {
  struct stat buffer;
  return stat(filename, &buffer) == 0;
}

int main(int argc, char *argv[]) {
  char *temp_dir = (char*)malloc(PATH_MAX * sizeof(char));
  char *c_file = (char*)malloc(PATH_MAX * sizeof(char));
  char *compile_cmd = (char*)malloc(PATH_MAX * sizeof(char));
  char *run_cmd = (char*)malloc(PATH_MAX * sizeof(char));
  char *nano_cmd = (char*)malloc(PATH_MAX * sizeof(char));
  char *output_file = (char*)malloc(PATH_MAX * sizeof(char));

  if (!temp_dir || !c_file || !compile_cmd || !run_cmd || !nano_cmd || !output_file) {
    fprintf(stderr, "Memory allocation failed\n");
    return 1;
  }

  if (argc > 1) {
    // Use provided program name
    snprintf(temp_dir, PATH_MAX, "/tmp/cshebang.%s", argv[1]);
    snprintf(c_file, PATH_MAX, "%s/%s.c", temp_dir, argv[1]);
  } else {
    // Create temporary directory
    FILE *temp = popen("mktemp -d /tmp/cshebang.XXXXXXXXX", "r");
    if (!temp) {
      fprintf(stderr, "Failed to create temporary directory\n");
      return 1;
    }
    fgets(temp_dir, PATH_MAX, temp);
    temp_dir[strcspn(temp_dir, "\n")] = 0; // Remove newline
    pclose(temp);

    snprintf(c_file, PATH_MAX, "%s/temp.c", temp_dir);
  }

  // Create directory if it doesn't exist
  mkdir(temp_dir, 0755);

  // Create cinclude.h file
  char *cinclude_file = malloc(PATH_MAX * sizeof(char));
  if (!cinclude_file) {
    fprintf(stderr, "Memory allocation failed\n");
    return 1;
  }
  snprintf(cinclude_file, PATH_MAX, "%s/cinclude.h", temp_dir);
  FILE *cinclude_fp = fopen(cinclude_file, "w");
  if (!cinclude_fp) {
    fprintf(stderr, "Failed to create cinclude.h file\n");
    return 1;
  }
  fprintf(cinclude_fp, "%s", cinclude_content);
  fclose(cinclude_fp);

  // Create C file with template if it doesn't exist
  if (!file_exists(c_file)) {
    FILE *fp = fopen(c_file, "w");
    if (!fp) {
      fprintf(stderr, "Failed to create C file\n");
      return 1;
    }
    fprintf(fp, "%s", template_code);
    fclose(fp);
  }

  // Open file in nano
  snprintf(nano_cmd, PATH_MAX, "nano %s", c_file);
  system(nano_cmd);

  // Get output file name
  snprintf(output_file, PATH_MAX, "%s/%s", temp_dir,
           argc > 1 ? argv[1] : "temp");

  // Compile
  snprintf(compile_cmd, PATH_MAX, "gcc -o %s %s", output_file, c_file);
  if (system(compile_cmd) != 0) {
    fprintf(stderr, "Compilation failed\n");
    return 1;
  }

  // Run
  snprintf(run_cmd, PATH_MAX, "%s", output_file);
  printf("\n--- Program Output ---\n");
  system(run_cmd);

  return 0;
}
