#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <unistd.h>

// Template C program
const char *template_code = "#include <stdio.h>\n"
                            "#include <stdlib.h>\n"
                            "\n"
                            "int main(int argc, char *argv[]) {\n"
                            "    printf(\"Hello, World!\\n\");\n"
                            "    return 0;\n"
                            "}\n";

int file_exists(const char *filename) {
  struct stat buffer;
  return stat(filename, &buffer) == 0;
}

int main(int argc, char *argv[]) {
  char temp_dir[4096];
  char c_file[512];
  char compile_cmd[4096];
  char run_cmd[1024];
  char nano_cmd[1024];

  if (argc > 1) {
    // Use provided program name
    snprintf(temp_dir, sizeof(temp_dir), "/tmp/cshebang.%s", argv[1]);
    snprintf(c_file, sizeof(c_file), "%s/%s.c", temp_dir, argv[1]);
  } else {
    // Create temporary directory
    FILE *temp = popen("mktemp -d /tmp/cshebang.XXXXXXXXX", "r");
    if (!temp) {
      fprintf(stderr, "Failed to create temporary directory\n");
      return 1;
    }
    fgets(temp_dir, sizeof(temp_dir), temp);
    temp_dir[strcspn(temp_dir, "\n")] = 0; // Remove newline
    pclose(temp);

    snprintf(c_file, sizeof(c_file), "%s/temp.c", temp_dir);
  }

  // Create directory if it doesn't exist
  mkdir(temp_dir, 0755);

  // Create C file with template if it doesn't exist
  if (!file_exists(c_file)) {
    FILE *fp = fopen(c_file, "w");
    if (!fp) {
      fprintf(stderr, "Failed to create C file\n");
      return 1;
    }
    fprintf(fp, "%s", template_code);
    fclose(fp);
  }

  // Open file in nano
  snprintf(nano_cmd, sizeof(nano_cmd), "nano %s", c_file);
  system(nano_cmd);

  // Get output file name
  char output_file[512];
  snprintf(output_file, sizeof(output_file), "%s/%s", temp_dir,
           argc > 1 ? argv[1] : "temp");

  // Compile
  snprintf(compile_cmd, sizeof(compile_cmd), "gcc -o %s %s", output_file,
           c_file);
  if (system(compile_cmd) != 0) {
    fprintf(stderr, "Compilation failed\n");
    return 1;
  }

  // Run
  snprintf(run_cmd, sizeof(run_cmd), "%s", output_file);
  printf("\n--- Program Output ---\n");
  system(run_cmd);

  return 0;
}
